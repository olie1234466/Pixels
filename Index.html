/* ===================== WEAPONS ===================== */
let weapon = "normal";
const weapons = {
  normal:{range:12,damage:1},
  long:{range:20,damage:1},
  fire:{range:16,damage:2}
};

/* ===================== SHOP ===================== */
function openShop(){
  let choice = prompt(
`SHOP
1 = Normal Sword
2 = Long Sword (unlock level 4)
3 = Fire Sword (unlock level 8)`
  );

  if(choice==="1") weapon="normal";
  if(choice==="2" && levelIndex>=3) weapon="long";
  if(choice==="3" && levelIndex>=7) weapon="fire";
}

/* ===================== BOSS ===================== */
let boss = null;

function spawnBoss(){
  boss = {
    x:250,
    y:GROUND-60,
    w:60,
    h:60,
    hp:10,
    dir:-1,
    shots:[]
  };
}

function updateBoss(){
  if(!boss) return;

  boss.x += boss.dir*1.5;
  if(boss.x<150 || boss.x>330) boss.dir*=-1;

  // shoot
  if(Math.random()<0.02){
    boss.shots.push({x:boss.x,y:boss.y+20,vx:-4});
  }

  boss.shots.forEach(s=>s.x+=s.vx);

  // hit player
  boss.shots.forEach(s=>{
    if(hit(player,{x:s.x,y:s.y,w:10,h:10})) loseLife();
  });

  // sword hit
  if(player.sword){
    const swordBox = {
      x:player.x+20,
      y:player.y,
      w:weapons[weapon].range,
      h:player.h
    };
    if(hit(swordBox,boss)){
      boss.hp -= weapons[weapon].damage;
    }
  }

  if(boss.hp<=0){
    alert("BOSS DEFEATED!");
    levelIndex=0;
    player.score+=500;
    boss=null;
  }
}

function drawBoss(){
  if(!boss) return;
  ctx.fillStyle="darkred";
  ctx.fillRect(boss.x,boss.y,boss.w,boss.h);

  // boss HP
  ctx.fillStyle="white";
  ctx.fillText("Boss HP: "+boss.hp,160,30);

  // shots
  ctx.fillStyle="orange";
  boss.shots.forEach(s=>{
    ctx.fillRect(s.x,s.y,10,10);
  });
}

/* ===================== MODIFY LOOP ===================== */
function update(){
  // normal update logic stays the same...

  if(levelIndex===11 && !boss){
    spawnBoss();
  }

  updateBoss();
}

function draw(){
  // normal draw logic stays the same...
  drawBoss();

  // sword
  if(player.sword){
    ctx.fillStyle=weapon==="fire"?"orange":"white";
    ctx.fillRect(
      player.x+20,
      player.y+8,
      weapons[weapon].range,
      4
    );
  }
}

/* ===================== SHOP BUTTON ===================== */
canvas.addEventListener("dblclick",openShop);
